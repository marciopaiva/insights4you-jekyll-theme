name: gem build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build Gem
    runs-on: ubuntu-latest
    permissions: write-all # Permite push

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby 3.1.4
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4

      # Instala dependências
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      # Gera notifications.yml
      - name: Generate Notifications Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               "https://api.github.com/repos/marciopaiva/insights4you-jekyll-theme/commits?per_page=5" > commits.json

          # Processa JSON para YAML (ajuste a sintaxe do jq)
          jq -r '.[] | {
            title: .commit.message,
            description: "\(.commit.author.name) · \(.commit.author.date | sub("\\.000Z$"; "Z") | fromdateiso8601 | strftime("%b %-d, %Y")),
            link: .html_url,
            color: "blue"
          }' commits.json | yq -P > _data/notifications.yml

      # Commit automático
      - name: Commit and Push Notifications
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote set-url origin "https://x-access-token:$GITHUB_TOKEN@github.com/marciopaiva/insights4you-jekyll-theme.git"
          git add _data/notifications.yml
          git commit -m "Auto-update notifications.yml" || echo "No changes to commit"
          git push origin main

      - name: Build the Gem
        run: |
          gem build *.gemspec
